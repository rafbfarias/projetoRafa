<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova Faturação - Sistema de Gestão</title>
    
    <!-- Estilos -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <link href="../../../css/styles.css" rel="stylesheet">
    <link href="../../../css/layout.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Componentes -->
    <script src="/js/Sidebar.js"></script>
    <script src="../../../js/layout.js"></script>
</head>
<body>
    <div class="app-container">
            <!-- Sidebar -->
        <aside class="sidebar">
            <app-sidebar></app-sidebar>
        </aside>

        <!-- Conteúdo Principal -->
        <main class="main-content">
        <!-- Sidebar -->
        <app-sidebar></app-sidebar>

        <!-- Conteúdo Principal -->
        <main class="flex-1 p-8">
            <div class="max-w-7xl mx-auto">
                <!-- Cabeçalho -->
                <div class="flex items-start justify-between mb-6">
                    <div class="flex flex-col items-start">
                        <h1 class="text-left text-2xl font-bold">Novo Registro de Faturação</h1>
                        <p class="text-muted">Preencha os dados da faturação conforme o talão fiscal</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <button type="button" class="btn btn-secondary" onclick="history.back()">
                            <i class="fas fa-arrow-left mr-2"></i>
                            <span>Voltar</span>
                        </button>
                        <button type="submit" class="btn btn-primary" id="saveButton">
                            <i class="fas fa-save mr-2"></i>
                            <span>Salvar Faturação</span>
                        </button>
                    </div>
                </div>

                <!-- Tabs Navigation -->
                <div class="border-b border-gray-200 mb-6">
                    <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="tabsNav">
                        <li class="me-2">
                            <a href="#" class="inline-flex items-center justify-center p-4 rounded-t-lg tab-active group" data-tab="info-geral">
                                <i class="fas fa-receipt w-4 h-4 me-2"></i>Informações Gerais
                            </a>
                        </li>
                        <li class="me-2">
                            <a href="#" class="inline-flex items-center justify-center p-4 rounded-t-lg tab-inactive group" data-tab="pagamentos">
                                <i class="fas fa-money-bill-wave w-4 h-4 me-2"></i>Métodos de Pagamento
                            </a>
                        </li>
                        <li class="me-2">
                            <a href="#" class="inline-flex items-center justify-center p-4 rounded-t-lg tab-inactive group" data-tab="delivery">
                                <i class="fas fa-motorcycle w-4 h-4 me-2"></i>Serviços de Entrega
                            </a>
                        </li>
                        <li class="me-2">
                            <a href="#" class="inline-flex items-center justify-center p-4 rounded-t-lg tab-inactive group" data-tab="cancelamentos">
                                <i class="fas fa-ban w-4 h-4 me-2"></i>Cancelamentos
                            </a>
                        </li>
                        <li class="me-2">
                            <a href="#" class="inline-flex items-center justify-center p-4 rounded-t-lg tab-inactive group" data-tab="operacoes">
                                <i class="fas fa-store w-4 h-4 me-2"></i>Operações Internas
                            </a>
                        </li>
                        <li class="me-2">
                            <a href="#" class="inline-flex items-center justify-center p-4 rounded-t-lg tab-inactive group" data-tab="metricas">
                                <i class="fas fa-chart-line w-4 h-4 me-2"></i>Métricas
                            </a>
                        </li>
                        <li class="me-2">
                            <a href="#" class="inline-flex items-center justify-center p-4 rounded-t-lg tab-inactive group" data-tab="fotos">
                                <i class="fas fa-images w-4 h-4 me-2"></i>Fotos
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Main Form Content -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Left Column - Photo Upload and Business Info -->
                    <div class="md:col-span-1">
                        <div class="photo-upload mb-6" id="main-photo-upload">
                            <i class="fas fa-image text-5xl text-gray-400 mb-3"></i>
                            <p class="text-gray-600 font-medium">Clique para adicionar uma foto do talão</p>
                            <p class="text-gray-500 text-sm mt-2">Formatos aceitos: JPG, PNG</p>
                            <input type="file" id="photoFactTotal" name="photoFactTotal" accept="image/*" class="hidden">
                        </div>

                        <!-- Business Information -->
                        <div class="bg-primary rounded-lg shadow-sm p-6 mb-6">
                            <h3 class="text-left" class="text-lg font-semibold mb-4 text-left">Informações do Negócio</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Empresa</label>
                                    <select id="companySelect" class="w-full p-2 rounded input-highlight text-sm" required>
                                        <option value="">Selecione a empresa</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Unidade</label>
                                    <select id="unitSelect" class="w-full p-2 rounded input-highlight text-sm" required disabled>
                                        <option value="">Selecione a unidade</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Responsável</label>
                                    <select id="factResp" class="w-full p-2 rounded input-highlight text-sm" required disabled>
                                        <option value="">Selecione o responsável</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Weather Banner -->
                        <div class="weather-banner mb-6">
                            <div class="weather-section sunny">
                                <div class="sun"></div>
                                <div class="weather-content">
                                    <h2 class="text-left">Temperatura</h2>
                                    <div class="temp" id="weatherTemp">--°C</div>
                                    <p id="weatherDesc">Carregando...</p>
                                </div>
                            </div>
                            
                            <div class="weather-section rainy">
                                <div class="cloud"></div>
                                <div class="raindrop" style="left: 20%; animation-duration: 1s;"></div>
                                <div class="raindrop" style="left: 30%; animation-duration: 1.2s;"></div>
                                <div class="weather-content">
                                    <h2 class="text-left">Precipitação</h2>
                                    <div class="temp" id="weatherPrecip">--%</div>
                                    <p>Probabilidade</p>
                                </div>
                            </div>
                            
                            <div class="weather-section windy">
                                <div class="wind" style="top: 30%; animation-duration: 2s;"></div>
                                <div class="wind" style="top: 60%; animation-duration: 1.8s;"></div>
                                <div class="weather-content">
                                    <h2 class="text-left">Vento</h2>
                                    <div class="temp" id="weatherWind">-- km/h</div>
                                    <p>Velocidade</p>
                                </div>
                            </div>
                        </div>

                        <!-- Day Evaluation -->
                        <div class="bg-secondary rounded-lg shadow-sm p-6">
                            <h3 class="text-left" class="text-lg font-semibold mb-4 text-left">Avaliação do Dia</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-right mb-4">
                                    <div class="flex space-x-1" id="starRating">
                                        <button class="text-4xl text-gray-300 hover:text-yellow-400 transition-colors" data-rating="1">★</button>
                                        <button class="text-4xl text-gray-300 hover:text-yellow-400 transition-colors" data-rating="2">★</button>
                                        <button class="text-4xl text-gray-300 hover:text-yellow-400 transition-colors" data-rating="3">★</button>
                                        <button class="text-4xl text-gray-300 hover:text-yellow-400 transition-colors" data-rating="4">★</button>
                                        <button class="text-4xl text-gray-300 hover:text-yellow-400 transition-colors" data-rating="5">★</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium bg-secondary text-secondary mb-1">Observações do Dia</label>
                                    <textarea id="dayObservations" rows="4" class="w-full p-2 rounded input-highlight text-sm" placeholder="Descreva como foi o dia..."></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium bg-secondary text-secondary mb-1">Quantidade de Visitantes</label>
                                    <input type="number" id="peopleCount" class="w-full p-2 rounded input-highlight text-sm" required>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column - Receipt Form -->
                    <div class="md:col-span-2">
                        <form id="faturacaoForm" class="receipt-container">
                            <!-- Hidden Fields -->
                            <input type="hidden" id="weekDay" name="weekDay">
                            <input type="hidden" id="weekNum" name="weekNum">
                            <input type="hidden" id="month" name="month">
                            <input type="hidden" id="year" name="year">
                            <input type="hidden" id="factDiff" name="factDiff" value="0">
                            <input type="hidden" id="dayWeatherDescription" name="dayWeatherDescription">
                            <input type="hidden" id="dayWeatherTemperature" name="dayWeatherTemperature">
                            <input type="hidden" id="dayWeatherPrecipitation" name="dayWeatherPrecipitation">
                            <input type="hidden" id="dayWeatherWindSpeed" name="dayWeatherWindSpeed">
                            <input type="hidden" id="dayEvaluation" name="dayEvaluation" value="0">
                            <input type="hidden" id="companyId" name="companyId">
                            <input type="hidden" id="unitId" name="unitId">
                            <input type="hidden" id="factRespId" name="factRespId">

                            <!-- Receipt Header -->
                            <div class="receipt-section receipt-header">
                                <div class="text-center mb-4" id="businessInfo">
                                    <h3 class="text-left" class="text-2xl font-bold mb-1 text-left">Plateiapositiva, Lda</h3>
                                    <p class="text-sm" id="selectedUnit">Selecione uma unidade</p>
                                    <p class="text-sm">Nr. Contribuinte: 510885411</p>
                                    <div class="font-bold mb-2">Fecho do dia por: <span id="selectedResp" class="text-blue-600">Selecione um responsável</span></div>
                                </div>

                                <div class="receipt-divider"></div>

                                <div class="mb-6">
                                    <div class="grid grid-cols-5 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Data/Hora</label>
                                            <input type="datetime-local" id="dateTime" name="dateTime" class="w-full p-2 rounded input-highlight text-sm" required>
                                        </div>
                                        <div class="grid grid-cols-1 gap-1">
                                            <p class="text-sm"><span class="font-medium">WeekDay:</span> <span id="weekDayDisplay">--</span></p>
                                        </div>
                                        <div class="grid grid-cols-1 gap-1">
                                            <p class="text-sm"><span class="font-medium">WeekNum:</span> <span id="weekNumDisplay">--</span></p>
                                        </div>
                                        <div class="grid grid-cols-1 gap-1">
                                            <p class="text-sm"><span class="font-medium">Mês:</span> <span id="monthDisplay">--</span></p>
                                        </div>
                                        <div class="grid grid-cols-1 gap-1">
                                            <p class="text-sm"><span class="font-medium">Ano:</span> <span id="yearDisplay">--</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Total por Modos de Pagamento -->
                            <div class="receipt-section">
                                <h3 class="text-left" class="font-bold text-gray-800 mb-3 text-left">Total por Modos de Pagamento</h3>
                                <table class="receipt-table">
                                    <tr>
                                        <td>Numerário Euro</td>
                                        <td>
                                            <input type="number" id="totalCash" name="totalCash" class="w-full p-2 text-right input-highlight" value="0.00" step="0.01">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Transferência Bancária</td>
                                        <td>
                                            <input type="number" id="wireTransfer" name="wireTransfer" class="w-full p-2 text-right input-highlight" value="0.00" step="0.01">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Multibanco 1</td>
                                        <td>
                                            <input type="number" id="posMb1Gross" name="posMb1Gross" class="w-full p-2 text-right input-highlight" value="0.00" step="0.01">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Multibanco 2</td>
                                        <td>
                                            <input type="number" id="posMb2Gross" name="posMb2Gross" class="w-full p-2 text-right input-highlight" value="0.00" step="0.01">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Uber Eats MB</td>
                                        <td>
                                            <input type="number" id="uberEatsMb" name="uberEatsMb" class="w-full p-2 text-right input-highlight" value="0.00" step="0.01">
                                        </td>
                                    </tr>
                                    <tr class="receipt-total">
                                        <td>Total da Faturação:</td>
                                        <td>
                                            <input type="number" id="totalFact" name="totalFact" class="w-full p-2 text-right font-bold bg-gray-50" value="0.00">
                                        </td>
                                    </tr>
                                    <tr id="factDiffRow" class="hidden">
                                        <td colspan="2" class="text-right text-red-500 text-sm pt-2">
                                            Diferença na faturação: <span id="factDiff">0.00</span>€
                                        </td>
                                    </tr>
                                </table>
                            </div>

                            <!-- Movimentos Anulados e Descontos -->
                            <div class="receipt-section">
                                <div class="grid grid-cols-1 gap-6">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="text-left">
                                            <h3 class="text-left" class="font-bold text-gray-800 mb-3 text-left">Movimentos Anulados</h3>
                                            <div class="space-y-4">
                                                <div>
                                                    <label class="text-sm">Total Transações:</label>
                                                    <input type="number" id="canceledTransactions" name="canceledTransactions" class="w-full p-2 text-right input-highlight" value="0.00" step="0.01">
                                                </div>
                                                <div>
                                                    <label class="text-sm">Total Documentos:</label>
                                                    <input type="number" id="canceledDocuments" name="canceledDocuments" class="w-full p-2 text-right input-highlight" value="0.00" step="0.01">
                                                </div>
                                                <div>
                                                    <label class="text-sm">Justificativa:</label>
                                                    <textarea id="canceledDocumentsJustification" name="canceledDocumentsJustification" class="w-full p-2 input-highlight" rows="2"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="text-left">
                                            <h3 class="text-left" class="font-bold text-gray-800 mb-3 text-left">Descontos</h3>
                                            <div class="space-y-4">
                                                <div>
                                                    <label class="text-sm">Total:</label>
                                                    <input type="number" id="discounts" name="discounts" class="w-full p-2 text-right input-highlight" value="0.00" step="0.01">
                                                </div>
                                                <div>
                                                    <label class="text-sm">Justificativa:</label>
                                                    <textarea id="discountsJustification" name="discountsJustification" class="w-full p-2 input-highlight" rows="2"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Consumo Interno e Gift Cards -->
                            <div class="receipt-section">
                                <div class="grid grid-cols-2 gap-6">
                                    <div class="text-left">
                                        <h3 class="text-left" class="font-bold text-gray-800 mb-3 text-left">Consumo Interno</h3>
                                        <div class="flex items-center gap-4">
                                            <label class="text-sm">Total:</label>
                                            <input type="number" id="internalConsumption" name="internalConsumption" class="w-48 p-2 text-right input-highlight" value="0.00" step="0.01">
                                        </div>
                                    </div>
                                    
                                    <div class="text-left">
                                        <h3 class="text-left" class="font-bold text-gray-800 mb-3 text-left">Gift Cards</h3>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label class="text-sm">Vendidos:</label>
                                                <input type="number" id="giftCardSold" name="giftCardSold" class="w-full p-2 text-right input-highlight" value="0.00" step="0.01">
                                            </div>
                                            <div>
                                                <label class="text-sm">Utilizados:</label>
                                                <input type="number" id="giftCardUsed" name="giftCardUsed" class="w-full p-2 text-right input-highlight" value="0.00" step="0.01">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Cascading Selects Logic
            const companySelect = document.getElementById('companySelect');
            const unitSelect = document.getElementById('unitSelect');
            const factRespSelect = document.getElementById('factResp');
            const businessInfo = document.getElementById('businessInfo');
            const selectedUnit = document.getElementById('selectedUnit');
            const selectedResp = document.getElementById('selectedResp');

            // Simulated data (replace with API calls)
            const companies = [
                { id: 1, name: 'Plateiapositiva, Lda' }
            ];

            const units = [
                { id: 1, companyId: 1, name: 'Matosinhos', address: 'Rua Sousa Aroso n° 544, Bloco A0.1 Fração K, 4450-286 Matosinhos' },
                { id: 2, companyId: 1, name: 'Porto', address: 'Rua do Porto, 123' }
            ];

            const users = [
                { id: 1, unitId: 1, name: 'João Silva' },
                { id: 2, unitId: 1, name: 'Maria Santos' },
                { id: 3, unitId: 2, name: 'Pedro Costa' }
            ];

            // Populate Companies
            companies.forEach(company => {
                const option = new Option(company.name, company.id);
                companySelect.add(option);
            });

            // Company Change Handler
            companySelect.addEventListener('change', function() {
                const companyId = this.value;
                document.getElementById('companyId').value = companyId;
                
                // Clear and disable subsequent selects
                unitSelect.innerHTML = '<option value="">Selecione a unidade</option>';
                factRespSelect.innerHTML = '<option value="">Selecione o responsável</option>';
                unitSelect.disabled = !companyId;
                factRespSelect.disabled = true;

                if (companyId) {
                    // Filter units by company
                    const companyUnits = units.filter(unit => unit.companyId == companyId);
                    companyUnits.forEach(unit => {
                        const option = new Option(unit.name, unit.id);
                        unitSelect.add(option);
                    });
                }
            });

            // Unit Change Handler
            unitSelect.addEventListener('change', function() {
                const unitId = this.value;
                document.getElementById('unitId').value = unitId;
                
                // Clear and disable user select
                factRespSelect.innerHTML = '<option value="">Selecione o responsável</option>';
                factRespSelect.disabled = !unitId;

                if (unitId) {
                    // Update unit info in receipt header
                    const selectedUnitData = units.find(u => u.id == unitId);
                    if (selectedUnitData) {
                        selectedUnit.innerHTML = selectedUnitData.address;
                    }

                    // Filter users by unit
                    const unitUsers = users.filter(user => user.unitId == unitId);
                    unitUsers.forEach(user => {
                        const option = new Option(user.name, user.id);
                        factRespSelect.add(option);
                    });
                }
            });

            // Responsible Change Handler
            factRespSelect.addEventListener('change', function() {
                const userId = this.value;
                document.getElementById('factRespId').value = userId;
                
                if (userId) {
                    const selectedUser = users.find(u => u.id == userId);
                    if (selectedUser) {
                        selectedResp.textContent = selectedUser.name;
                    }
                }
            });

            // Exemplo de unidades (será substituído pelos dados da API)
            const unitsExample = [
                { id: 1, code: 'MAT', name: 'Matosinhos', color: 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200' },
                { id: 2, code: 'POR', name: 'Porto', color: 'bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200' },
                { id: 3, code: 'LIS', name: 'Lisboa', color: 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200' },
                { id: 4, code: 'BRA', name: 'Braga', color: 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200' }
            ];

            // Renderizar avatares das unidades
            function renderUnitAvatars() {
                const unitSelector = document.getElementById('unitSelector');
                if (unitsExample.length > 0) {
                    unitSelector.innerHTML = unitsExample.map(unit => `
                        <div class="unit-avatar ${unit.color} group" data-unit-id="${unit.id}" data-unit-code="${unit.code}">
                            <span class="unit-code">${unit.code}</span>
                            <span class="unit-name">${unit.name}</span>
                            <div class="absolute -top-2 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-2 py-1 rounded text-xs opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
                                ${unit.name}
                            </div>
                        </div>
                    `).join('');

                    // Adicionar eventos de clique
                    document.querySelectorAll('.unit-avatar').forEach(avatar => {
                        avatar.addEventListener('click', function() {
                            document.querySelectorAll('.unit-avatar').forEach(a => {
                                a.classList.remove('selected');
                                a.classList.remove('scale-105');
                            });
                            this.classList.add('selected');
                            this.classList.add('scale-105');
                            updateFactId(this.dataset.unitCode);
                        });
                    });
                }
            }

            // Função para gerar o ID da faturação
            function generateFactId(unitCode = 'MAT') {
                const year = document.querySelector('input[name="year"]').value;
                const month = new Date(document.querySelector('input[name="dateTime"]').value).getMonth() + 1;
                const day = new Date(document.querySelector('input[name="dateTime"]').value).getDate();
                const total = parseFloat(document.getElementById('totalFact').value.replace(',', '.'));
                
                if (year && month && day && total) {
                    const formattedMonth = month.toString().padStart(2, '0');
                    const formattedDay = day.toString().padStart(2, '0');
                    const formattedTotal = total.toFixed(2).replace('.', '');
                    return `${year}.${formattedMonth}.${formattedDay}.${unitCode}.${formattedTotal}`;
                }
                return '-';
            }

            // Atualizar ID da faturação
            function updateFactId(unitCode) {
                const idDisplay = document.getElementById('factIdDisplay');
                const newId = generateFactId(unitCode);
                
                idDisplay.style.opacity = '0';
                setTimeout(() => {
                    idDisplay.textContent = newId;
                    idDisplay.style.opacity = '1';
                }, 200);
            }

            // Inicializar
            renderUnitAvatars();

            // Manipulação de abas
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    // Remover classe active de todas as abas
                    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    
                    // Adicionar classe active na aba clicada
                    this.classList.add('active');
                    const content = document.querySelector(`.tab-content[data-tab="${this.dataset.tab}"]`);
                    if (content) {
                        content.classList.remove('hidden');
                    }
                });
            });

            // Upload de imagem
            const uploadArea = document.getElementById('uploadArea');
            const photoInput = document.getElementById('photoInput');
            const photoPreview = document.getElementById('photoPreview');
            const uploadPrompt = document.getElementById('uploadPrompt');

            uploadArea.addEventListener('click', () => photoInput.click());
            uploadArea.addEventListener('dragover', e => {
                e.preventDefault();
                uploadArea.classList.add('border-blue-500');
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('border-blue-500');
            });
            uploadArea.addEventListener('drop', e => {
                e.preventDefault();
                uploadArea.classList.remove('border-blue-500');
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    handleImageUpload(file);
                }
            });

            photoInput.addEventListener('change', e => {
                const file = e.target.files[0];
                if (file) handleImageUpload(file);
            });

            function handleImageUpload(file) {
                const reader = new FileReader();
                reader.onload = e => {
                    photoPreview.src = e.target.result;
                    photoPreview.classList.remove('hidden');
                    uploadPrompt.classList.add('hidden');
                    uploadArea.classList.add('has-image');
                };
                reader.readAsDataURL(file);
            }

            // Configurar data e hora atual
            const now = new Date();
            const dateTimeInput = document.getElementById('dateTime');
            dateTimeInput.value = now.toISOString().slice(0, 16);
            updateDateFields(now);

            // Atualizar campos de data quando mudar a data/hora
            dateTimeInput.addEventListener('change', function() {
                const selectedDate = new Date(this.value);
                updateDateFields(selectedDate);
            });

            // Função para atualizar campos de data
            function updateDateFields(date) {
                const weekdays = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
                const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                
                document.getElementById('weekDayDisplay').textContent = weekdays[date.getDay()];
                document.getElementById('weekNumDisplay').textContent = getWeekNumber(date);
                document.getElementById('monthDisplay').textContent = months[date.getMonth()];
                document.getElementById('yearDisplay').textContent = date.getFullYear();

                // Update hidden fields
                document.getElementById('weekDay').value = weekdays[date.getDay()];
                document.getElementById('weekNum').value = getWeekNumber(date);
                document.getElementById('month').value = months[date.getMonth()];
                document.getElementById('year').value = date.getFullYear();
            }

            // Calcular número da semana
            function getWeekNumber(d) {
                d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
                const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
                const weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
                return weekNo;
            }

            // Cálculo automático do total da faturação
            const paymentInputs = ['totalCash', 'wireTransfer', 'posMb1Gross', 'posMb2Gross', 'uberEatsMb'];
            paymentInputs.forEach(inputId => {
                document.getElementById(inputId).addEventListener('input', updateTotal);
            });

            // Monitor total faturação para diferenças
            document.getElementById('totalFact').addEventListener('input', checkFactDiff);

            function updateTotal() {
                const total = paymentInputs.reduce((sum, inputId) => {
                    return sum + (parseFloat(document.getElementById(inputId).value) || 0);
                }, 0);
                const totalFactInput = document.getElementById('totalFact');
                const previousValue = parseFloat(totalFactInput.value) || 0;
                totalFactInput.value = total.toFixed(2);
                
                // Check for differences
                checkFactDiff();
            }

            function checkFactDiff() {
                const calculatedTotal = paymentInputs.reduce((sum, inputId) => {
                    return sum + (parseFloat(document.getElementById(inputId).value) || 0);
                }, 0);
                const inputTotal = parseFloat(document.getElementById('totalFact').value) || 0;
                const diff = inputTotal - calculatedTotal;
                
                const diffRow = document.getElementById('factDiffRow');
                const diffSpan = document.getElementById('factDiff');
                
                if (Math.abs(diff) > 0.01) { // Use small threshold for floating point comparison
                    diffRow.classList.remove('hidden');
                    diffSpan.textContent = diff.toFixed(2);
                    document.getElementById('factDiff').value = diff;
                } else {
                    diffRow.classList.add('hidden');
                    document.getElementById('factDiff').value = 0;
                }
            }

            // Weather API Integration
            async function fetchWeatherData() {
                const API_KEY = '7b7d1d0873483aa586e78293efef4d07';
                try {
                    // Get user's location
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject);
                    });

                    const { latitude, longitude } = position.coords;
                    const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${latitude}&lon=${longitude}&appid=${API_KEY}&units=metric`);
                    const data = await response.json();

                    // Update weather fields
                    document.getElementById('weatherTemp').textContent = `${Math.round(data.main.temp)}°C`;
                    document.getElementById('weatherDesc').textContent = data.weather[0].description;
                    document.getElementById('weatherPrecip').textContent = `${data.main.humidity}%`;
                    document.getElementById('weatherWind').textContent = `${Math.round(data.wind.speed * 3.6)} km/h`;

                    // Update hidden form fields
                    document.getElementById('dayWeatherDescription').value = data.weather[0].description;
                    document.getElementById('dayWeatherTemperature').value = data.main.temp;
                    document.getElementById('dayWeatherPrecipitation').value = data.main.humidity;
                    document.getElementById('dayWeatherWindSpeed').value = data.wind.speed;

                    // Update weather animation based on conditions
                    updateWeatherAnimation(data.weather[0].main);
                } catch (error) {
                    console.error('Error fetching weather data:', error);
                }
            }

            // Star Rating System
            const starRating = document.getElementById('starRating');
            let currentRating = 0;

            starRating.addEventListener('mouseover', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const rating = parseInt(e.target.dataset.rating);
                    updateStars(rating, true);
                }
            });

            starRating.addEventListener('mouseout', () => {
                updateStars(currentRating, false);
            });

            starRating.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    currentRating = parseInt(e.target.dataset.rating);
                    updateStars(currentRating, false);
                    document.getElementById('dayEvaluation').value = currentRating;
                }
            });

            function updateStars(rating, isHover) {
                const stars = starRating.children;
                for (let i = 0; i < stars.length; i++) {
                    stars[i].classList.toggle('text-yellow-400', i < rating);
                    stars[i].classList.toggle('text-gray-300', i >= rating);
                }
            }

            // Initialize weather data
            fetchWeatherData();
        });
    </script>
        </main>
    </div>
</body>
</html> 