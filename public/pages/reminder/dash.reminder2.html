import React, { useState, useEffect, useRef } from 'react';
import { 
  Calendar, 
  ChevronLeft, 
  ChevronRight, 
  Grid3X3, 
  Calendar as CalendarIcon, 
  List, 
  Search, 
  PlusCircle, 
  Edit3, 
  Trash2, 
  X, 
  Save, 
  Maximize2, 
  Minimize2,
  Filter,
  Eye,
  ExternalLink 
} from 'lucide-react';

const CalendarReminderBoard = () => {
  // Estados para gerenciar visualização e dados
  const [viewMode, setViewMode] = useState('month'); // 'month', 'week', 'day', 'board'
  const [currentDate, setCurrentDate] = useState(new Date());
  const [notes, setNotes] = useState([]);
  const [showModal, setShowModal] = useState(false);
  const [modalType, setModalType] = useState(null); // 'new', 'edit', 'view', 'delete'
  const [currentNote, setCurrentNote] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedTypes, setSelectedTypes] = useState(['all']);
  const [showFilterDropdown, setShowFilterDropdown] = useState(false);
  const [showEmptyState, setShowEmptyState] = useState(true);
  const [isResizing, setIsResizing] = useState(false);
  const [resizeDirection, setResizeDirection] = useState(null);
  const [startResizePos, setStartResizePos] = useState({ x: 0, y: 0 });
  const [startResizeSize, setStartResizeSize] = useState({ width: 0, height: 0 });
  const [isDragging, setIsDragging] = useState(false);
  const [dragOffsetX, setDragOffsetX] = useState(0);
  const [dragOffsetY, setDragOffsetY] = useState(0);
  
  const boardRef = useRef(null);
  
  // Tipos de notas e suas configurações
  const noteTypes = {
    task: { label: 'Tarefa', bgColor: 'bg-gray-500' },
    user: { label: 'Usuário', bgColor: 'bg-blue-500' },
    contract: { label: 'Contrato', bgColor: 'bg-purple-500' },
    expense: { label: 'Despesa', bgColor: 'bg-red-500' },
    revenue: { label: 'Receita', bgColor: 'bg-green-500' }
  };
  
  // Prioridades e suas configurações
  const notePriorities = {
    low: { 
      label: 'Baixa', 
      className: 'bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-400'
    },
    medium: { 
      label: 'Média', 
      className: 'bg-yellow-100 dark:bg-yellow-900 text-yellow-600 dark:text-yellow-400'
    },
    high: { 
      label: 'Alta', 
      className: 'bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-400'
    }
  };
  
  // Carregar notas ao iniciar
  useEffect(() => {
    const savedNotes = localStorage.getItem('reminderNotes');
    if (savedNotes) {
      const parsedNotes = JSON.parse(savedNotes);
      setNotes(parsedNotes);
      setShowEmptyState(parsedNotes.length === 0);
    }
  }, []);
  
  // Salvar notas ao atualizar
  useEffect(() => {
    localStorage.setItem('reminderNotes', JSON.stringify(notes));
    setShowEmptyState(notes.length === 0);
  }, [notes]);
  
  // Manipulação da navegação do calendário
  const goToNextPeriod = () => {
    const newDate = new Date(currentDate);
    if (viewMode === 'month') {
      newDate.setMonth(newDate.getMonth() + 1);
    } else if (viewMode === 'week') {
      newDate.setDate(newDate.getDate() + 7);
    } else if (viewMode === 'day') {
      newDate.setDate(newDate.getDate() + 1);
    }
    setCurrentDate(newDate);
  };
  
  const goToPreviousPeriod = () => {
    const newDate = new Date(currentDate);
    if (viewMode === 'month') {
      newDate.setMonth(newDate.getMonth() - 1);
    } else if (viewMode === 'week') {
      newDate.setDate(newDate.getDate() - 7);
    } else if (viewMode === 'day') {
      newDate.setDate(newDate.getDate() - 1);
    }
    setCurrentDate(newDate);
  };
  
  const goToToday = () => {
    setCurrentDate(new Date());
  };
  
  // Funções de formatação de data
  const formatMonth = (date) => {
    return date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
  };
  
  const formatWeek = (date) => {
    const startOfWeek = new Date(date);
    startOfWeek.setDate(date.getDate() - date.getDay());
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);
    
    return `${startOfWeek.getDate()} ${startOfWeek.toLocaleDateString('pt-BR', { month: 'short' })} - ${endOfWeek.getDate()} ${endOfWeek.toLocaleDateString('pt-BR', { month: 'short' })} ${endOfWeek.getFullYear()}`;
  };
  
  const formatDay = (date) => {
    return date.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
  };
  
  // Obter dias do mês atual
  const getDaysInMonth = () => {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    // Primeiro dia do mês
    const firstDay = new Date(year, month, 1);
    
    // Último dia do mês
    const lastDay = new Date(year, month + 1, 0);
    
    // Dias do mês anterior para preencher a primeira semana
    const daysFromPrevMonth = firstDay.getDay();
    const prevMonthLastDay = new Date(year, month, 0).getDate();
    
    const days = [];
    
    // Adicionar dias do mês anterior
    for (let i = daysFromPrevMonth - 1; i >= 0; i--) {
      const day = new Date(year, month - 1, prevMonthLastDay - i);
      days.push({ date: day, isCurrentMonth: false });
    }
    
    // Adicionar dias do mês atual
    for (let i = 1; i <= lastDay.getDate(); i++) {
      const day = new Date(year, month, i);
      days.push({ date: day, isCurrentMonth: true });
    }
    
    // Adicionar dias do próximo mês
    const nextMonthDays = 42 - days.length; // 6 semanas * 7 dias = 42
    for (let i = 1; i <= nextMonthDays; i++) {
      const day = new Date(year, month + 1, i);
      days.push({ date: day, isCurrentMonth: false });
    }
    
    return days;
  };
  
  // Obter dias da semana atual
  const getDaysInWeek = () => {
    const week = [];
    const startOfWeek = new Date(currentDate);
    startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
    
    for (let i = 0; i < 7; i++) {
      const day = new Date(startOfWeek);
      day.setDate(startOfWeek.getDate() + i);
      week.push({ date: day, isCurrentMonth: day.getMonth() === currentDate.getMonth() });
    }
    
    return week;
  };
  
  // Obter notas para uma data específica
  const getNotesForDate = (date) => {
    return notes.filter(note => {
      const noteDate = new Date(note.date);
      return noteDate.toDateString() === date.toDateString() &&
        (selectedTypes.includes('all') || selectedTypes.includes(note.type)) &&
        (searchTerm === '' || 
         note.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
         note.content.toLowerCase().includes(searchTerm.toLowerCase()));
    });
  };
  
  // Filtrar notas com base nos filtros atuais
  const getFilteredNotes = () => {
    return notes.filter(note => {
      return (selectedTypes.includes('all') || selectedTypes.includes(note.type)) &&
        (searchTerm === '' || 
         note.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
         note.content.toLowerCase().includes(searchTerm.toLowerCase()));
    });
  };
  
  // Manipulação de notas
  const openNewNoteModal = (date = null) => {
    setCurrentNote({
      id: `note-${Date.now()}`,
      type: 'task',
      title: '',
      content: '',
      priority: 'medium',
      color: 'yellow',
      date: date ? date.toISOString() : new Date().toISOString(),
      posX: Math.random() * (window.innerWidth * 0.6) + 50,
      posY: Math.random() * (window.innerHeight * 0.5) + 50,
      width: 250,
      height: 180
    });
    setModalType('new');
    setShowModal(true);
  };
  
  const openEditNoteModal = (note) => {
    setCurrentNote({...note});
    setModalType('edit');
    setShowModal(true);
  };
  
  const openViewNoteModal = (note) => {
    setCurrentNote({...note});
    setModalType('view');
    setShowModal(true);
  };
  
  const openDeleteNoteModal = (note) => {
    setCurrentNote({...note});
    setModalType('delete');
    setShowModal(true);
  };
  
  const closeModal = () => {
    setShowModal(false);
    setModalType(null);
    setCurrentNote(null);
  };
  
  const handleSaveNote = () => {
    if (!currentNote.title.trim()) {
      alert('Por favor, informe um título para a nota.');
      return;
    }
    
    if (modalType === 'new') {
      setNotes([...notes, currentNote]);
    } else if (modalType === 'edit') {
      setNotes(notes.map(note => note.id === currentNote.id ? currentNote : note));
    }
    
    closeModal();
  };
  
  const handleDeleteNote = () => {
    setNotes(notes.filter(note => note.id !== currentNote.id));
    closeModal();
  };
  
  const handleNoteTypeChange = (e) => {
    const type = e.target.value;
    setCurrentNote({...currentNote, type});
  };
  
  const handleColorSelect = (color) => {
    setCurrentNote({...currentNote, color});
  };
  
  // Manipulação de drag e redimensionamento
  const handleMouseDown = (e, note) => {
    if (e.target.closest('.resize-handle') || viewMode !== 'board') return;
    
    e.preventDefault();
    e.stopPropagation();
    
    const noteElement = e.currentTarget;
    const boundingRect = noteElement.getBoundingClientRect();
    const boardRect = boardRef.current.getBoundingClientRect();
    
    setIsDragging(true);
    setCurrentNote(note);
    setDragOffsetX(e.clientX - boundingRect.left + boardRect.left - note.posX);
    setDragOffsetY(e.clientY - boundingRect.top + boardRect.top - note.posY);
  };
  
  const handleMouseMove = (e) => {
    if (isDragging && currentNote && boardRef.current) {
      e.preventDefault();
      
      const boardRect = boardRef.current.getBoundingClientRect();
      const boardScrollTop = boardRef.current.scrollTop;
      const boardScrollLeft = boardRef.current.scrollLeft;
      
      const newX = e.clientX - boardRect.left - dragOffsetX + boardScrollLeft;
      const newY = e.clientY - boardRect.top - dragOffsetY + boardScrollTop;
      
      // Limitar as bordas do board
      const boardWidth = boardRef.current.scrollWidth;
      const boardHeight = boardRef.current.scrollHeight;
      
      const limitedX = Math.max(0, Math.min(newX, boardWidth - currentNote.width));
      const limitedY = Math.max(0, Math.min(newY, boardHeight - currentNote.height));
      
      setNotes(notes.map(note => 
        note.id === currentNote.id ? {...note, posX: limitedX, posY: limitedY} : note
      ));
    } else if (isResizing && currentNote) {
      e.preventDefault();
      
      const dx = e.clientX - startResizePos.x;
      const dy = e.clientY - startResizePos.y;
      
      let newWidth = startResizeSize.width;
      let newHeight = startResizeSize.height;
      let newX = currentNote.posX;
      let newY = currentNote.posY;
      
      if (resizeDirection.includes('right')) {
        newWidth = Math.max(150, startResizeSize.width + dx);
      }
      if (resizeDirection.includes('bottom')) {
        newHeight = Math.max(100, startResizeSize.height + dy);
      }
      if (resizeDirection.includes('left')) {
        newWidth = Math.max(150, startResizeSize.width - dx);
        newX = startResizeSize.width - dx < 150 ? currentNote.posX : currentNote.posX + dx;
      }
      if (resizeDirection.includes('top')) {
        newHeight = Math.max(100, startResizeSize.height - dy);
        newY = startResizeSize.height - dy < 100 ? currentNote.posY : currentNote.posY + dy;
      }
      
      setNotes(notes.map(note => 
        note.id === currentNote.id ? {...note, posX: newX, posY: newY, width: newWidth, height: newHeight} : note
      ));
    }
  };
  
  const handleMouseUp = () => {
    setIsDragging(false);
    setIsResizing(false);
    setResizeDirection(null);
  };
  
  const handleResizeStart = (e, note, direction) => {
    e.preventDefault();
    e.stopPropagation();
    
    setIsResizing(true);
    setCurrentNote(note);
    setResizeDirection(direction);
    setStartResizePos({ x: e.clientX, y: e.clientY });
    setStartResizeSize({ width: note.width, height: note.height });
  };
  
  // Renderização do calendário mensal
  const renderMonthView = () => {
    const days = getDaysInMonth();
    
    return (
      <div className="grid grid-cols-7 gap-1">
        {/* Cabeçalho com dias da semana */}
        {['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'].map((day, index) => (
          <div 
            key={`header-${index}`} 
            className="py-2 text-center text-sm font-medium text-gray-600 dark:text-gray-400"
          >
            {day}
          </div>
        ))}
        
        {/* Células do calendário */}
        {days.map((day, index) => {
          const dayNotes = getNotesForDate(day.date);
          const isToday = day.date.toDateString() === new Date().toDateString();
          
          return (
            <div 
              key={`day-${index}`}
              className={`border border-gray-200 dark:border-gray-700 min-h-24 p-1 
                ${day.isCurrentMonth ? 'bg-white dark:bg-gray-800' : 'bg-gray-100 dark:bg-gray-900'} 
                ${isToday ? 'ring-2 ring-blue-500 dark:ring-blue-400' : ''}`}
              onClick={() => openNewNoteModal(day.date)}
            >
              <div className="flex justify-between">
                <span 
                  className={`inline-block rounded-full w-7 h-7 text-center leading-7 
                    ${isToday ? 'bg-blue-500 text-white' : ''}
                    ${!day.isCurrentMonth ? 'text-gray-400 dark:text-gray-500' : ''}`}
                >
                  {day.date.getDate()}
                </span>
                {dayNotes.length > 0 && (
                  <span className="bg-blue-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">
                    {dayNotes.length}
                  </span>
                )}
              </div>
              
              <div className="mt-1 space-y-1 overflow-hidden max-h-20">
                {dayNotes.slice(0, 3).map(note => (
                  <div 
                    key={note.id}
                    className={`text-xs p-1 rounded truncate cursor-pointer note-color-${note.color} border-l-4 border-${note.color}-500`}
                    onClick={(e) => {
                      e.stopPropagation();
                      openViewNoteModal(note);
                    }}
                  >
                    {note.title}
                  </div>
                ))}
                {dayNotes.length > 3 && (
                  <div 
                    className="text-xs text-center text-blue-500 hover:text-blue-700 dark:text-blue-400 cursor-pointer"
                    onClick={(e) => {
                      e.stopPropagation();
                      // Aqui você poderia implementar uma visualização de todas as notas do dia
                      // Por simplicidade, usaremos a primeira nota
                      openViewNoteModal(dayNotes[0]);
                    }}
                  >
                    + {dayNotes.length - 3} mais
                  </div>
                )}
              </div>
            </div>
          );
        })}
      </div>
    );
  };
  
  // Renderização do calendário semanal
  const renderWeekView = () => {
    const days = getDaysInWeek();
    
    return (
      <div className="grid grid-cols-7 gap-1 h-full">
        {/* Cabeçalho com dias da semana */}
        {days.map((day, index) => {
          const isToday = day.date.toDateString() === new Date().toDateString();
          
          return (
            <div 
              key={`header-${index}`} 
              className={`py-2 text-center ${isToday ? 'text-blue-500 font-bold' : 'text-gray-600 dark:text-gray-400'}`}
            >
              <div className="text-sm font-medium">
                {day.date.toLocaleDateString('pt-BR', { weekday: 'short' })}
              </div>
              <div className={`text-xl ${isToday ? 'bg-blue-500 text-white rounded-full w-10 h-10 flex items-center justify-center mx-auto' : ''}`}>
                {day.date.getDate()}
              </div>
            </div>
          );
        })}
        
        {/* Células do calendário */}
        {days.map((day, index) => {
          const dayNotes = getNotesForDate(day.date);
          const isToday = day.date.toDateString() === new Date().toDateString();
          
          return (
            <div 
              key={`day-${index}`}
              className={`border border-gray-200 dark:border-gray-700 min-h-64 overflow-y-auto p-2
                ${day.isCurrentMonth ? 'bg-white dark:bg-gray-800' : 'bg-gray-100 dark:bg-gray-900'} 
                ${isToday ? 'ring-2 ring-blue-500 dark:ring-blue-400' : ''}`}
              onClick={() => openNewNoteModal(day.date)}
            >
              <div className="space-y-2">
                {dayNotes.map(note => (
                  <div 
                    key={note.id}
                    className={`p-2 rounded shadow-sm cursor-pointer note-color-${note.color} border-l-4 border-${note.color}-500`}
                    onClick={(e) => {
                      e.stopPropagation();
                      openViewNoteModal(note);
                    }}
                  >
                    <div className="flex justify-between items-center">
                      <span className={`px-2 py-0.5 text-xs rounded text-white ${noteTypes[note.type].bgColor}`}>
                        {noteTypes[note.type].label}
                      </span>
                      <div className="flex space-x-1">
                        <button 
                          className="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300"
                          onClick={(e) => {
                            e.stopPropagation();
                            openEditNoteModal(note);
                          }}
                        >
                          <Edit3 size={14} />
                        </button>
                        <button 
                          className="text-gray-500 hover:text-red-500 dark:text-gray-400 dark:hover:text-red-400"
                          onClick={(e) => {
                            e.stopPropagation();
                            openDeleteNoteModal(note);
                          }}
                        >
                          <Trash2 size={14} />
                        </button>
                      </div>
                    </div>
                    <h3 className="font-medium text-gray-800 dark:text-white mt-1">{note.title}</h3>
                    <p className="text-sm text-gray-600 dark:text-gray-300 line-clamp-2">{note.content}</p>
                    <div className="mt-1 flex justify-between items-center text-xs text-gray-500 dark:text-gray-400">
                      <span className={`px-2 py-0.5 rounded ${notePriorities[note.priority].className}`}>
                        {notePriorities[note.priority].label}
                      </span>
                    </div>
                  </div>
                ))}
                {dayNotes.length === 0 && (
                  <div className="h-full flex flex-col items-center justify-center text-gray-400 dark:text-gray-500 p-4">
                    <PlusCircle className="w-6 h-6 mb-2" />
                    <p className="text-sm">Adicionar nota</p>
                  </div>
                )}
              </div>
            </div>
          );
        })}
      </div>
    );
  };
  
  // Renderização do quadro livre
  const renderBoardView = () => {
    const filteredNotes = getFilteredNotes();
    
    return (
      <div 
        ref={boardRef}
        className="relative bg-white dark:bg-gray-800 rounded-lg shadow-lg w-full h-full overflow-auto"
        style={{ 
          backgroundImage: 'linear-gradient(to right, var(--bg-gray-200) 1px, transparent 1px), linear-gradient(to bottom, var(--bg-gray-200) 1px, transparent 1px)',
          backgroundSize: '20px 20px',
          padding: '1px'
        }}
        onMouseMove={handleMouseMove}
        onMouseUp={handleMouseUp}
        onMouseLeave={handleMouseUp}
        onClick={() => openNewNoteModal()}
      >
        {filteredNotes.map(note => (
          <div
            key={note.id}
            className={`note absolute bg-white dark:bg-gray-700 shadow-lg rounded-lg p-3 cursor-move note-color-${note.color}`}
            style={{
              top: `${note.posY}px`,
              left: `${note.posX}px`,
              width: `${note.width}px`,
              height: `${note.height}px`,
              borderTop: `3px solid var(--bg-${note.color}-500)`
            }}
            onMouseDown={(e) => handleMouseDown(e, note)}
          >
            <div className="note-header flex justify-between items-center mb-2">
              <div className={`note-type px-2 py-0.5 rounded text-xs font-semibold text-white ${noteTypes[note.type].bgColor}`}>
                {noteTypes[note.type].label}
              </div>
              <div className="note-actions flex space-x-1">
                <button 
                  className="note-edit text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300"
                  onClick={(e) => {
                    e.stopPropagation();
                    openEditNoteModal(note);
                  }}
                >
                  <Edit3 size={14} />
                </button>
                <button 
                  className="note-delete text-gray-500 hover:text-red-500 dark:text-gray-400 dark:hover:text-red-400"
                  onClick={(e) => {
                    e.stopPropagation();
                    openDeleteNoteModal(note);
                  }}
                >
                  <Trash2 size={14} />
                </button>
              </div>
            </div>
            <div className="note-content overflow-auto" style={{ maxHeight: 'calc(100% - 60px)' }}>
              <h3 className="font-medium text-gray-800 dark:text-white mb-1">{note.title}</h3>
              <p className="text-sm text-gray-600 dark:text-gray-300">{note.content}</p>
            </div>
            <div className="note-footer mt-2 flex justify-between items-center text-xs text-gray-500 dark:text-gray-400">
              <span className="note-date">
                {new Date(note.date).toLocaleDateString('pt-BR')}
              </span>
              <span className={`note-priority px-2 py-0.5 rounded ${notePriorities[note.priority].className}`}>
                {notePriorities[note.priority].label}
              </span>
            </div>
            
            {/* Elementos para redimensionamento */}
            <div
              className="resize-handle absolute bottom-0 right-0 w-4 h-4 cursor-se-resize"
              onMouseDown={(e) => handleResizeStart(e, note, 'bottom-right')}
            >
              <svg width="10" height="10" viewBox="0 0 10 10" className="fill-current text-gray-400">
                <path d="M0 10L10 10L10 0Z"></path>
              </svg>
            </div>
            <div
              className="resize-handle absolute bottom-0 left-0 w-4 h-4 cursor-sw-resize"
              onMouseDown={(e) => handleResizeStart(e, note, 'bottom-left')}
            ></div>
            <div
              className="resize-handle absolute top-0 right-0 w-4 h-4 cursor-ne-resize"
              onMouseDown={(e) => handleResizeStart(e, note, 'top-right')}
            ></div>
            <div
              className="resize-handle absolute top-0 left-0 w-4 h-4 cursor-nw-resize"
              onMouseDown={(e) => handleResizeStart(e, note, 'top-left')}
            ></div>
            <div
              className="resize-handle absolute right-0 top-1/2 w-4 h-8 -mt-4 cursor-e-resize"
              onMouseDown={(e) => handleResizeStart(e, note, 'right')}
            ></div>
            <div
              className="resize-handle absolute left-0 top-1/2 w-4 h-8 -mt-4 cursor-w-resize"
              onMouseDown={(e) => handleResizeStart(e, note, 'left')}
            ></div>
            <div
              className="resize-handle absolute bottom-0 left-1/2 h-4 w-8 -ml-4 cursor-s-resize"
              onMouseDown={(e) => handleResizeStart(e, note, 'bottom')}
            ></div>
            <div
              className="resize-handle absolute top-0 left-1/2 h-4 w-8 -ml-4 cursor-n-resize"
              onMouseDown={(e) => handleResizeStart(e, note, 'top')}
            ></div>
          </div>
        ))}
        
        {/* Mensagem de board vazio */}
        {showEmptyState && (
          <div className="absolute inset-0 flex flex-col items-center justify-center text-gray-400 dark:text-gray-500">
            <Calendar className="w-16 h-16 mb-4" />
            <p className="text-xl font-medium">Seu board está vazio</p>
            <p className="text-sm mt-2">Adicione notas ou selecione elementos do sistema para começar</p>
            <button 
              className="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center"
              onClick={(e) => {
                e.stopPropagation();
                openNewNoteModal();
              }}
            >
              <PlusCircle className="mr-2" size={16} />
              Adicionar nota
            </button>
          </div>
        )}
      </div>
    );
  };
  
  // Função para gerar visualização do dia
  const renderDayView = () => {
    const dayNotes = getNotesForDate(currentDate);
    const hours = Array.from({ length: 24 }, (_, i) => i);
    
    return (
      <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg h-full overflow-y-auto">
        <div className="grid grid-cols-1 divide-y divide-gray-200 dark:divide-gray-700">
          <div className="p-4 sticky top-0 bg-white dark:bg-gray-800 z-10 border-b">
            <h2 className="text-xl font-semibold">{formatDay(currentDate)}</h2>
            <button 
              className="mt-2 flex items-center text-blue-500 hover:text-blue-700"
              onClick={() => openNewNoteModal(currentDate)}
            >
              <PlusCircle size={16} className="mr-1" />
              <span className="text-sm">Adicionar nota</span>
            </button>
          </div>
          
          {hours.map(hour => {
            const hourNotes = dayNotes.filter(note => {
              const noteDate = new Date(note.date);
              return noteDate.getHours() === hour;
            });
            
            return (
              <div key={`hour-${hour}`} className="p-2 hover:bg-gray-50 dark:hover:bg-gray-700">
                <div className="flex items-start">
                  <div className="w-16 text-right pr-4 text-gray-500 dark:text-gray-400 font-medium">
                    {hour.toString().padStart(2, '0')}:00
                  </div>
                  <div className="flex-1">
                    {hourNotes.length > 0 ? (
                      <div className="space-y-2">
                        {hourNotes.map(note => (
                          <div 
                            key={note.id}
                            className={`p-3 rounded shadow-sm cursor-pointer note-color-${note.color} border-l-4 border-${note.color}-500`}
                            onClick={() => openViewNoteModal(note)}
                          >
                            <div className="flex justify-between items-center">
                              <span className={`px-2 py-0.5 text-xs rounded text-white ${noteTypes[note.type].bgColor}`}>
                                {noteTypes[note.type].label}
                              </span>
                              <div className="flex space-x-1">
                                <button 
                                  className="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    openEditNoteModal(note);
                                  }}
                                >
                                  <Edit3 size={14} />
                                </button>
                                <button 
                                  className="text-gray-500 hover:text-red-500 dark:text-gray-400 dark:hover:text-red-400"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    openDeleteNoteModal(note);
                                  }}
                                >
                                  <Trash2 size={14} />
                                </button>
                              </div>
                            </div>
                            <h3 className="font-medium text-gray-800 dark:text-white mt-1">{note.title}</h3>
                            <p className="text-sm text-gray-600 dark:text-gray-300">{note.content}</p>
                            <div className="mt-1 flex justify-between items-center text-xs text-gray-500 dark:text-gray-400">
                              <span className={`px-2 py-0.5 rounded ${notePriorities[note.priority].className}`}>
                                {notePriorities[note.priority].label}
                              </span>
                            </div>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <div 
                        className="h-8 border border-dashed border-gray-300 dark:border-gray-600 rounded flex items-center justify-center text-gray-400 dark:text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer"
                        onClick={() => {
                          const newDate = new Date(currentDate);
                          newDate.setHours(hour);
                          openNewNoteModal(newDate);
                        }}
                      >
                        <PlusCircle size={14} className="mr-1" />
                        <span className="text-xs">Adicionar</span>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      </div>
    );
  };
  
  // Alternar filtros de tipo
  const toggleTypeFilter = (type) => {
    if (type === 'all') {
      setSelectedTypes(['all']);
    } else {
      const newSelectedTypes = selectedTypes.filter(t => t !== 'all');
      
      if (newSelectedTypes.includes(type)) {
        // Remove o tipo se já estiver selecionado
        const filteredTypes = newSelectedTypes.filter(t => t !== type);
        setSelectedTypes(filteredTypes.length ? filteredTypes : ['all']);
      } else {
        // Adiciona o tipo à seleção
        setSelectedTypes([...newSelectedTypes, type]);
      }
    }
  };
  
  // Renderizar o modal atual
  const renderModal = () => {
    if (!showModal) return null;
    
    // Modal de visualização
    if (modalType === 'view') {
      return (
        <div className="fixed inset-0 bg-black/50 dark:bg-gray-900/80 flex items-center justify-center z-50">
          <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-4 overflow-hidden">
            <div className="flex items-center justify-between p-4 border-b dark:border-gray-700">
              <div className="flex items-center">
                <span className={`px-2 py-1 rounded text-xs font-semibold text-white ${noteTypes[currentNote.type].bgColor} mr-2`}>
                  {noteTypes[currentNote.type].label}
                </span>
                <h3 className="text-lg font-semibold text-gray-900 dark:text-white">
                  {currentNote.title}
                </h3>
              </div>
              <button 
                className="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300"
                onClick={closeModal}
              >
                <X size={18} />
              </button>
            </div>
            <div className="p-4">
              <p className="text-gray-600 dark:text-gray-300 whitespace-pre-line">{currentNote.content}</p>
              <div className="mt-4 flex justify-between items-center text-sm text-gray-500 dark:text-gray-400">
                <span className="flex items-center">
                  <Calendar size={14} className="mr-1" />
                  {new Date(currentNote.date).toLocaleDateString('pt-BR', { 
                    weekday: 'short', 
                    day: 'numeric', 
                    month: 'short', 
                    year: 'numeric' 
                  })}
                </span>
                <span className={`px-2 py-1 rounded ${notePriorities[currentNote.priority].className}`}>
                  {notePriorities[currentNote.priority].label}
                </span>
              </div>
              {currentNote.elementId && (
                <div className="mt-4 pt-4 border-t dark:border-gray-700">
                  <a 
                    href="#" 
                    className="flex items-center text-blue-500 hover:text-blue-700"
                    onClick={(e) => {
                      e.preventDefault();
                      // Aqui você redirecionaria para o elemento associado
                      alert(`Navegar para ${currentNote.type} com ID: ${currentNote.elementId}`);
                    }}
                  >
                    <ExternalLink size={14} className="mr-1" />
                    <span className="text-sm">Ver elemento associado</span>
                  </a>
                </div>
              )}
            </div>
            <div className="flex border-t dark:border-gray-700">
              <button 
                className="flex-1 py-3 flex items-center justify-center text-blue-600 hover:bg-blue-50 dark:text-blue-400 dark:hover:bg-blue-900/20"
                onClick={() => {
                  closeModal();
                  setTimeout(() => openEditNoteModal(currentNote), 100);
                }}
              >
                <Edit3 size={14} className="mr-2" />
                Editar
              </button>
              <button 
                className="flex-1 py-3 flex items-center justify-center text-red-600 hover:bg-red-50 dark:text-red-400 dark:hover:bg-red-900/20 border-l dark:border-gray-700"
                onClick={() => {
                  closeModal();
                  setTimeout(() => openDeleteNoteModal(currentNote), 100);
                }}
              >
                <Trash2 size={14} className="mr-2" />
                Excluir
              </button>
            </div>
          </div>
        </div>
      );
    }
    
    // Modal de exclusão
    if (modalType === 'delete') {
      return (
        <div className="fixed inset-0 bg-black/50 dark:bg-gray-900/80 flex items-center justify-center z-50">
          <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-4 overflow-hidden">
            <div className="p-6">
              <div className="flex items-center justify-center w-12 h-12 rounded-full bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-400 mx-auto mb-4">
                <Trash2 size={20} />
              </div>
              <h3 className="text-xl font-medium text-center text-gray-900 dark:text-white mb-2">
                Confirmar exclusão
              </h3>
              <p className="text-center text-gray-600 dark:text-gray-400">
                Tem certeza que deseja excluir a nota "{currentNote.title}"? Esta ação não pode ser desfeita.
              </p>
            </div>
            <div className="flex border-t dark:border-gray-700">
              <button 
                className="w-full py-3 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors font-medium"
                onClick={closeModal}
              >
                Cancelar
              </button>
              <button 
                className="w-full py-3 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors font-medium border-l dark:border-gray-700"
                onClick={handleDeleteNote}
              >
                Excluir
              </button>
            </div>
          </div>
        </div>
      );
    }
    
    // Modal de nova nota ou edição
    return (
      <div className="fixed inset-0 bg-black/50 dark:bg-gray-900/80 flex items-center justify-center z-50">
        <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-4 overflow-hidden">
          <div className="flex items-center justify-between p-4 border-b dark:border-gray-700">
            <h3 className="text-lg font-semibold text-gray-900 dark:text-white">
              {modalType === 'new' ? 'Nova Nota' : 'Editar Nota'}
            </h3>
            <button 
              className="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300"
              onClick={closeModal}
            >
              <X size={18} />
            </button>
          </div>
          <div className="p-4">
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                  Tipo
                </label>
                <select 
                  className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                  value={currentNote.type}
                  onChange={handleNoteTypeChange}
                >
                  <option value="task">Tarefa</option>
                  <option value="user">Usuário</option>
                  <option value="contract">Contrato</option>
                  <option value="expense">Despesa</option>
                  <option value="revenue">Receita</option>
                </select>
              </div>
              
              {currentNote.type !== 'task' && (
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Elemento de referência
                  </label>
                  <select 
                    className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                    value={currentNote.elementId || ''}
                    onChange={(e) => setCurrentNote({...currentNote, elementId: e.target.value || null})}
                  >
                    <option value="">Selecione um elemento...</option>
                    {/* Exemplo de elementos para cada tipo */}
                    {currentNote.type === 'user' && (
                      <>
                        <option value="user-1">Ana Silva - ana.silva@exemplo.com</option>
                        <option value="user-2">Bruno Santos - bruno.santos@exemplo.com</option>
                        <option value="user-3">Carla Oliveira - carla.oliveira@exemplo.com</option>
                      </>
                    )}
                    {currentNote.type === 'contract' && (
                      <>
                        <option value="contract-1">Contrato #2025-001 - Ana Silva</option>
                        <option value="contract-2">Contrato #2025-002 - Bruno Santos</option>
                        <option value="contract-3">Contrato #2025-003 - Carla Oliveira</option>
                      </>
                    )}
                    {currentNote.type === 'expense' && (
                      <>
                        <option value="expense-1">Despesa #EXP-2025-001 - Aluguel Matosinhos</option>
                        <option value="expense-2">Despesa #EXP-2025-002 - Fornecedor Café</option>
                        <option value="expense-3">Despesa #EXP-2025-003 - Manutenção Porto</option>
                      </>
                    )}
                    {currentNote.type === 'revenue' && (
                      <>
                        <option value="revenue-1">Receita #FAT-2025-001 - Matosinhos (05/03/2025)</option>
                        <option value="revenue-2">Receita #FAT-2025-002 - Porto (03/03/2025)</option>
                        <option value="revenue-3">Receita #FAT-2025-003 - Matosinhos (01/03/2025)</option>
                      </>
                    )}
                  </select>
                </div>
              )}

              <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                  Título
                </label>
                <input 
                  type="text" 
                  className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                  placeholder="Digite um título para a nota"
                  value={currentNote.title}
                  onChange={(e) => setCurrentNote({...currentNote, title: e.target.value})}
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                  Conteúdo
                </label>
                <textarea 
                  className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                  placeholder="Digite o conteúdo da nota"
                  rows="4"
                  value={currentNote.content}
                  onChange={(e) => setCurrentNote({...currentNote, content: e.target.value})}
                ></textarea>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                  Data
                </label>
                <input 
                  type="datetime-local"
                  className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                  value={new Date(currentNote.date).toISOString().slice(0, 16)}
                  onChange={(e) => setCurrentNote({
                    ...currentNote, 
                    date: e.target.value ? new Date(e.target.value).toISOString() : new Date().toISOString()
                  })}
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                  Prioridade
                </label>
                <select 
                  className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                  value={currentNote.priority}
                  onChange={(e) => setCurrentNote({...currentNote, priority: e.target.value})}
                >
                  <option value="low">Baixa</option>
                  <option value="medium">Média</option>
                  <option value="high">Alta</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                  Cor
                </label>
                <div className="flex space-x-2">
                  {['yellow', 'blue', 'green', 'red', 'purple', 'pink', 'gray'].map(color => (
                    <div 
                      key={color} 
                      className={`cursor-pointer w-8 h-8 rounded-full hover:ring-2 hover:ring-offset-2 hover:ring-${color}-400 
                        ${currentNote.color === color ? `ring-2 ring-offset-2 ring-${color}-400` : ''}`}
                      style={{ backgroundColor: `var(--bg-${color}-100)` }}
                      onClick={() => handleColorSelect(color)}
                    ></div>
                  ))}
                </div>
              </div>
            </div>
          </div>
          <div className="flex justify-end items-center p-4 border-t dark:border-gray-700">
            <button 
              className="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 mr-2"
              onClick={closeModal}
            >
              Cancelar
            </button>
            <button 
              className="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700"
              onClick={handleSaveNote}
            >
              <Save size={16} className="inline-block mr-1" />
              {modalType === 'new' ? 'Salvar' : 'Atualizar'}
            </button>
          </div>
        </div>
      </div>
    );
  };

  return (
    <div className="bg-gray-50 dark:bg-gray-900 min-h-screen p-4 md:p-8">
      {/* Cabeçalho */}
      <div className="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
        <div className="mb-4 md:mb-0">
          <h1 className="text-2xl font-bold text-gray-900 dark:text-white">Reminder Board</h1>
          <p className="text-gray-600 dark:text-gray-400">Organize suas tarefas e lembretes em um quadro visual</p>
        </div>
        <div className="flex flex-wrap gap-2">
          <div className="relative">
            <div className="flex items-center h-10 rounded-lg border border-gray-300 dark:border-gray-600 overflow-hidden bg-white dark:bg-gray-800">
              <div className="px-2 text-gray-500 dark:text-gray-400">
                <Search size={18} />
              </div>
              <input 
                type="text" 
                className="h-full bg-transparent border-none focus:outline-none text-gray-900 dark:text-white p-2"
                placeholder="Pesquisar notas..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
              />
              {searchTerm && (
                <button 
                  className="px-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"
                  onClick={() => setSearchTerm('')}
                >
                  <X size={18} />
                </button>
              )}
            </div>
          </div>
          
          <div className="relative">
            <button 
              className="flex items-center h-10 px-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200"
              onClick={() => setShowFilterDropdown(!showFilterDropdown)}
            >
              <Filter size={18} className="mr-1" />
              <span>Filtros</span>
            </button>
            
            {showFilterDropdown && (
              <div className="absolute right-0 mt-2 w-64 bg-white dark:bg-gray-800 rounded-lg shadow-lg z-10 border border-gray-200 dark:border-gray-700">
                <div className="p-4">
                  <h4 className="font-medium text-gray-900 dark:text-white mb-2">Filtrar por tipo</h4>
                  <div className="space-y-2">
                    <label className="flex items-center">
                      <input 
                        type="checkbox" 
                        className="h-4 w-4 text-blue-600 rounded border-gray-300"
                        checked={selectedTypes.includes('all')}
                        onChange={() => toggleTypeFilter('all')}
                      />
                      <span className="ml-2 text-gray-700 dark:text-gray-300">Todos</span>
                    </label>
                    {Object.entries(noteTypes).map(([type, { label }]) => (
                      <label key={type} className="flex items-center">
                        <input 
                          type="checkbox" 
                          className="h-4 w-4 text-blue-600 rounded border-gray-300"
                          checked={selectedTypes.includes(type) || selectedTypes.includes('all')}
                          onChange={() => toggleTypeFilter(type)}
                          disabled={selectedTypes.includes('all')}
                        />
                        <span className="ml-2 text-gray-700 dark:text-gray-300">{label}</span>
                      </label>
                    ))}
                  </div>
                </div>
              </div>
            )}
          </div>
          
          <button 
            className="flex items-center h-10 px-3 rounded-lg bg-blue-500 hover:bg-blue-600 text-white"
            onClick={() => openNewNoteModal()}
          >
            <PlusCircle size={18} className="mr-1" />
            <span>Nova Nota</span>
          </button>
        </div>
      </div>
      
      {/* Controles de navegação */}
      <div className="bg-white dark:bg-gray-800 rounded-lg shadow-sm mb-4 p-4">
        <div className="flex flex-col sm:flex-row justify-between items-center">
          <div className="flex items-center mb-4 sm:mb-0">
            <button 
              className="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"
              onClick={goToPreviousPeriod}
            >
              <ChevronLeft size={24} className="text-gray-700 dark:text-gray-300" />
            </button>
            
            <button 
              className="mx-2 px-3 py-1 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded"
              onClick={goToToday}
            >
              Hoje
            </button>
            
            <button 
              className="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"
              onClick={goToNextPeriod}
            >
              <ChevronRight size={24} className="text-gray-700 dark:text-gray-300" />
            </button>
            
            <h2 className="ml-4 text-xl font-semibold text-gray-900 dark:text-white">
              {viewMode === 'month' && formatMonth(currentDate)}
              {viewMode === 'week' && formatWeek(currentDate)}
              {viewMode === 'day' && formatDay(currentDate)}
              {viewMode === 'board' && 'Quadro de Notas'}
            </h2>
          </div>
          
          <div className="flex bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
            <button 
              className={`p-2 rounded-md ${viewMode === 'day' ? 'bg-white dark:bg-gray-600 shadow-sm' : 'text-gray-700 dark:text-gray-300'}`}
              onClick={() => setViewMode('day')}
            >
              <span className="sr-only">Dia</span>
              <CalendarIcon size={18} />
            </button>
            <button 
              className={`p-2 rounded-md ${viewMode === 'week' ? 'bg-white dark:bg-gray-600 shadow-sm' : 'text-gray-700 dark:text-gray-300'}`}
              onClick={() => setViewMode('week')}
            >
              <span className="sr-only">Semana</span>
              <List size={18} />
            </button>
            <button 
              className={`p-2 rounded-md ${viewMode === 'month' ? 'bg-white dark:bg-gray-600 shadow-sm' : 'text-gray-700 dark:text-gray-300'}`}
              onClick={() => setViewMode('month')}
            >
              <span className="sr-only">Mês</span>
              <Calendar size={18} />
            </button>
            <button 
              className={`p-2 rounded-md ${viewMode === 'board' ? 'bg-white dark:bg-gray-600 shadow-sm' : 'text-gray-700 dark:text-gray-300'}`}
              onClick={() => setViewMode('board')}
            >
              <span className="sr-only">Quadro</span>
              <Grid3X3 size={18} />
            </button>
          </div>
        </div>
      </div>
      
      {/* Conteúdo principal - Calendário ou Board */}
      <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg" style={{ height: 'calc(100vh - 220px)' }}>
        {viewMode === 'month' && renderMonthView()}
        {viewMode === 'week' && renderWeekView()}
        {viewMode === 'day' && renderDayView()}
        {viewMode === 'board' && renderBoardView()}
      </div>
      
      {/* Modais */}
      {renderModal()}
    </div>
  );
};

export default CalendarReminderBoard;