<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novo Usuário - Sistema de Gestão</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="../../../css/styles.css" rel="stylesheet">
    <script src="../../../js/Sidebar.js"></script>
</head>
<body class="bg-primary">
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <app-sidebar></app-sidebar>

        <!-- Conteúdo Principal -->
        <main class="flex-1 p-8 overflow-y-auto">
            <!-- Cabeçalho -->
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8">
                <div class="text-left">
                    <h1 class="text-left text-2xl font-bold">Novo Usuário</h1>
                    <p class="text-muted">Adicione um novo usuário ao sistema</p>
                </div>
                <div class="mt-4 md:mt-0">
                    <a href="user-management.html" class="btn btn-secondary">
                        <i class="fas fa-arrow-left mr-2 text-xl" style="color: var(--icon-clients-text);""></i>
                        <span>Voltar para Usuários</span>
                    </a>
                </div>
            </div>

            <!-- Cartão de Perfil -->
            <div class="dashboard-card p-6 mb-6">
                <div class="flex flex-col md:flex-row md:items-center gap-6">
                    <!-- Área da Foto -->
                    <div class="relative">
                        <div class="w-24 h-24 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center overflow-hidden">
                            <img id="userPhoto" src="../../../images/default-avatar.svg" alt="Foto do usuário" class="w-full h-full object-cover hidden">
                            <i class="fas fa-user text-4xl text-gray-400 dark:text-gray-500 text-xl" style="color: var(--icon-clients-text);"" id="defaultAvatar"></i>
                        </div>
                        <label for="photoInput" class="absolute bottom-0 right-0 w-8 h-8 bg-brand-500 rounded-full flex items-center justify-center cursor-pointer hover:bg-brand-600">
                            <i class="fas fa-camera text-white text-sm "" style="color: var(--icon-clients-text);"></i>
                        </label>
                        <input type="file" id="photoInput" class="hidden" accept="image/*">
                    </div>

                    <!-- Informações do Usuário -->
                    <div class="flex-1">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                            <div class="text-left">
                                <h2 class="text-left" id="displayName" class="text-xl font-bold">Novo Usuário</h2>
                                <p id="displayEmail" class="text-muted">Email não definido</p>
                            </div>
                        </div>

                        <!-- Badges -->
                        <div class="flex flex-wrap gap-3 mt-4">
                            <div class="px-3 py-1 rounded-full bg-gray-100 dark:bg-gray-700 text-sm">
                                <span class="text-gray-500 dark:text-gray-400">Status:</span>
                                <span id="statusBadge" class="text-gray-800 dark:text-gray-200 ml-1">Pendente</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formulário -->
            <div class="dashboard-card">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-user-plus text-xl text-brand-500 "" style="color: var(--icon-clients-text);"></i>
                        <h2 class="text-left" class="text-xl font-bold text-left">Informações do Usuário</h2>
                    </div>
                </div>

                <form id="userForm" class="p-6 space-y-6">
                    <!-- Grid de 2 colunas -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Nome Preferido -->
                        <div class="space-y-2">
                            <label for="preferredName" class="block text-sm font-medium">Nome Preferido</label>
                            <input type="text" id="preferredName" name="preferredName" required
                                class="form-input w-full">
                        </div>

                        <!-- Nome Completo -->
                        <div class="space-y-2">
                            <label for="fullName" class="block text-sm font-medium">Nome Completo</label>
                            <input type="text" id="fullName" name="fullName" required
                                class="form-input w-full">
                        </div>

                        <!-- Email -->
                        <div class="space-y-2">
                            <label for="email" class="block text-sm font-medium">Email *</label>
                            <input type="email" id="email" name="email" required
                                class="form-input w-full">
                        </div>

                        <!-- Status -->
                        <div class="space-y-2">
                            <label for="userStatus" class="block text-sm font-medium">Status *</label>
                            <select id="userStatus" name="userStatus" required
                                class="form-select w-full">
                                <option value="Pendente">Pendente</option>
                                <option value="Ativa">Ativa</option>
                                <option value="Inativa">Inativa</option>
                            </select>
                        </div>
                    </div>

                    <!-- Alerta de Informações -->
                    <div class="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                        <h4 class="text-sm font-medium text-blue-700 dark:text-blue-400 mb-2">Importante</h4>
                        <ul class="text-sm space-y-1 text-blue-600 dark:text-blue-300">
                            <li>• Superadmins têm acesso total ao sistema</li>
                            <li>• Admins podem ser designados como responsáveis por unidades</li>
                            <li>• Gerentes têm acesso limitado às suas unidades designadas</li>
                            <li>• Operadores têm acesso apenas às funcionalidades básicas</li>
                            <li>• A senha inicial pode ser alterada pelo usuário após o primeiro acesso</li>
                        </ul>
                    </div>

                    <!-- Botões de Ação -->
                    <div class="flex justify-end space-x-4 mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                        <a href="user-management.html" class="btn btn-secondary">
                            Cancelar
                        </a>
                        <button type="submit" id="submitButton" class="btn btn-primary">
                            Criar Usuário
                        </button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('userForm');
        const photoInput = document.getElementById('photoInput');
        const userPhoto = document.getElementById('userPhoto');
        const defaultAvatar = document.getElementById('defaultAvatar');
        const preferredNameInput = document.getElementById('preferredName');
        const fullNameInput = document.getElementById('fullName');
        const emailInput = document.getElementById('email');
        const displayName = document.getElementById('displayName');
        const displayEmail = document.getElementById('displayEmail');
        const userStatusSelect = document.getElementById('userStatus');
        const submitButton = document.getElementById('submitButton');

        // Atualiza o display do nome e email enquanto digita
        preferredNameInput.addEventListener('input', function() {
            displayName.textContent = this.value || 'Novo Usuário';
        });

        emailInput.addEventListener('input', function() {
            displayEmail.textContent = this.value || 'Email não definido';
        });

        // Preview da foto
        photoInput.addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    userPhoto.src = e.target.result;
                    userPhoto.classList.remove('hidden');
                    defaultAvatar.classList.add('hidden');
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        // Atualiza o badge de status
        userStatusSelect.addEventListener('change', function() {
            const statusBadge = document.getElementById('statusBadge');
            statusBadge.textContent = this.value;
            
            // Atualizar a cor do badge
            const parentDiv = statusBadge.closest('div');
            
            // Remover classes anteriores
            parentDiv.className = parentDiv.className.replace(/bg-\w+-\d+ dark:bg-\w+-\d+/g, '');
            
            // Adicionar novas classes com base no status
            if (this.value === 'Ativa') {
                parentDiv.classList.add('bg-green-100', 'dark:bg-green-800');
                statusBadge.className = statusBadge.className.replace(/text-\w+-\d+ dark:text-\w+-\d+/g, '');
                statusBadge.classList.add('text-green-800', 'dark:text-green-200');
            } else if (this.value === 'Inativa') {
                parentDiv.classList.add('bg-red-100', 'dark:bg-red-800');
                statusBadge.className = statusBadge.className.replace(/text-\w+-\d+ dark:text-\w+-\d+/g, '');
                statusBadge.classList.add('text-red-800', 'dark:text-red-200');
            } else {
                parentDiv.classList.add('bg-yellow-100', 'dark:bg-yellow-800');
                statusBadge.className = statusBadge.className.replace(/text-\w+-\d+ dark:text-\w+-\d+/g, '');
                statusBadge.classList.add('text-yellow-800', 'dark:text-yellow-200');
            }
        });

        // Submit do formulário
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2 text-xl" style="color: var(--icon-clients-text);""></i>Criando...';

            try {
                // Preparar os dados do usuário conforme o modelo existente
                const userData = {
                    preferredName: preferredNameInput.value,
                    fullName: fullNameInput.value,
                    email: emailInput.value,
                    userStatus: userStatusSelect.value,
                    currentUnit: 'Não definida', // Campo obrigatório se status não for Pendente
                };

                // Adicionar foto se existir
                if (photoInput.files && photoInput.files[0]) {
                    userData.photo = '/images/users/' + photoInput.files[0].name;
                }

                console.log('Enviando dados:', userData);

                // Enviar para a API existente
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Erro ao criar usuário');
                }

                // Exibir notificação de sucesso
                showNotification('Usuário criado com sucesso!', 'success');

                // Redirecionar para a lista de usuários após 1 segundo
                setTimeout(() => {
                    window.location.href = 'user-management.html?userCreated=true';
                }, 1000);

            } catch (error) {
                console.error('Erro ao criar usuário:', error);
                showNotification(error.message || 'Erro ao criar usuário', 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = 'Criar Usuário';
            }
        });
        
        /**
         * Exibe uma notificação na tela
         * @param {string} message - Mensagem a ser exibida
         * @param {string} type - Tipo de notificação (success, error, warning, info)
         */
        function showNotification(message, type = 'info') {
            // Criar elemento de notificação
            const notification = document.createElement('div');
            notification.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg z-50 ${getNotificationClass(type)}`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${getNotificationIcon(type)} mr-3"></i>
                    <span>${message}</span>
                </div>
            `;
            
            // Adicionar à página
            document.body.appendChild(notification);
            
            // Remover após 3 segundos
            setTimeout(() => {
                notification.classList.add('opacity-0');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        /**
         * Retorna a classe CSS para o tipo de notificação
         * @param {string} type - Tipo de notificação
         * @returns {string} Classe CSS
         */
        function getNotificationClass(type) {
            switch (type) {
                case 'success':
                    return 'bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-200';
                case 'error':
                    return 'bg-red-100 dark:bg-red-800 text-red-800 dark:text-red-200';
                case 'warning':
                    return 'bg-yellow-100 dark:bg-yellow-800 text-yellow-800 dark:text-yellow-200';
                case 'info':
                default:
                    return 'bg-blue-100 dark:bg-blue-800 text-blue-800 dark:text-blue-200';
            }
        }

        /**
         * Retorna o ícone para o tipo de notificação
         * @param {string} type - Tipo de notificação
         * @returns {string} Classe do ícone
         */
        function getNotificationIcon(type) {
            switch (type) {
                case 'success':
                    return 'fa-check-circle';
                case 'error':
                    return 'fa-times-circle';
                case 'warning':
                    return 'fa-exclamation-circle';
                case 'info':
                default:
                    return 'fa-info-circle';
            }
        }
    });
    </script>
</body>
</html> 